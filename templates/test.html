<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
    <title>간단한 지도 표시하기</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=lqj4d734cm"></script>
    <script type="text/javascript" src="https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=lqj4d734cm&submodules=panorama"></script>
    <style>
        /* 전체 레이아웃 스타일링 */
        .layout-container {
            display: flex;
        }

        /* 왼쪽 컨테이너 스타일링 */
        .left-container {
            /* position: absolute; */
            width: 65%;
        }
        
        /* .right {
            float: right;
        } */

        /* 지도와 파노라마 스타일링 */
        #map, #pano {
            width: 100%; /* 컨테이너 너비에 맞춤 */
        }

        #map {
            height: 760px;
        }

        #pano {
            height: 300px;
        }

        /* 오른쪽 컨테이너 (바) 스타일링 */
        #bar {

            width: 35%; /* 너비 조정 */
            height: 1060px; /* 기존 높이 유지 */
            background-color: #f2f2f2; /* 배경색 */
            /* 추가적인 스타일링 */
        }

        .find-btn {
            text-align: center; /* 텍스트 중앙 정렬 */
        }

        /* find-btn1 클래스에 대한 스타일링 (현재 사용되지 않음) */
        .find-btn1 {
            display: inline-block; /* 인라인 블록 요소로 표시 */
        }

    </style>
</head>
<body>
    <div id="button-container">
        <button id="street">거리뷰</button>
    </div>
    <div class="layout-container">
        <div class="left-container">
            <div id="map" class="left"></div>
            <div id="pano"></div>
        </div>
        <div id="" class="right">
            <div class="find-btn">
                <button type="button" onclick="loadRestaurantsByCategory('한식')">한식</button>
                <button type="button" onclick="loadRestaurantsByCategory('일식')">일식</button>
                <button type="button" onclick="loadRestaurantsByCategory('중식')">중식</button>
                <button type="button" onclick="loadRestaurantsByCategory('분식')">분식</button>
            </div>
            <div id="restaurants-list">
                <h3>레스토랑 목록</h3>
                <ul id="restaurant-list-ul">
                    <!-- 여기에 목록이 동적으로 추가됩니다. -->
                </ul>
            </div>
            <div class="review-item">
                <h4>메뉴</h4>
                <p id="food-item-1">${name}</p>
                <p id="food-item-2">음식 2</p>
                <p id="food-item-3">음식 3</p>
                <p id="food-item-4">음식 4</p>
            </div>
                <button>평점선택</button>
                <p></p>
                <button type="button" onclick="">로그인 시 작성가능합니다 .</button>
            </div>
        </div>
    </div>


<script>
var map = new naver.maps.Map('map', {
    center: new naver.maps.LatLng(37.3005585, 127.0347399),
    zoom: 17
});

var pano = null;
naver.maps.onJSContentLoaded = function() {
    // 아이디 혹은 지도 좌표로 파노라마를 표시할 수 있습니다.
    pano = new naver.maps.Panorama("pano", {
        position: new naver.maps.LatLng(37.3005585, 127.0347399),
        pov: {
            pan: -133,
            tilt: 0,
            fov: 100
        }
    });
    // 파노라마 위치가 갱신되었을 때 발생하는 이벤트를 받아 지도의 중심 위치를 갱신합니다.
    naver.maps.Event.addListener(pano, 'pano_changed', function() {
        var latlng = pano.getPosition();
        if (!latlng.equals(map.getCenter())) {
            map.setCenter(latlng);
        }
    });
};
// 거리뷰 레이어를 생성합니다.
var streetLayer = new naver.maps.StreetLayer();
naver.maps.Event.once(map, 'init', function() {
    streetLayer.setMap(map);
});

// 거리뷰 버튼에 이벤트를 바인딩합니다.
var btn = $('#street');
var markers = [];
var latlngs = [];

btn.on("click", function(e) {
    e.preventDefault();

    // 거리뷰 레이어가 지도 위에 있으면 거리뷰 레이어를 지도에서 제거하고,
    // 거리뷰 레이어가 지도 위에 없으면 거리뷰 레이어를 지도에 추가합니다.
    if (streetLayer.getMap()) {
        streetLayer.setMap(null);
        // 마커 생성
        console.log(latlngs);
        showMarkers();
    } else {
        streetLayer.setMap(map);
        // 마커 숨기기
        hideMarkers();
    }
});

naver.maps.Event.addListener(map, 'streetLayer_changed', function(streetLayer) {
    if (streetLayer) {
        btn.addClass('control-on');
        // 마우스 오버 이벤트 활성화
        showMarkersOnHover();
    } else {
        btn.removeClass('control-on');
        // 마커 숨기기
        hideMarkers();
    }
});

naver.maps.Event.addListener(map, 'click', function(e) {
    if (streetLayer.getMap()) {
        var latlng = e.coord;
        pano.setPosition(latlng);
    }
});

function createMarker(position, name) {
    console.log(name);
    var marker = new naver.maps.Marker({
        position: position,
        map: map
    });

    var infoWindow = new naver.maps.InfoWindow({
        content: '<div style="width:150px;text-align:center;padding:10px;">Marker at (' + position.lat() + ', ' + position.lng() + ')</div>',
        disableAutoPan: true
    });

    naver.maps.Event.addListener(marker, 'mouseover', function() {
        infoWindow.open(map, marker);
    });

    naver.maps.Event.addListener(marker, 'mouseout', function() {
        infoWindow.close();
    });

    naver.maps.Event.addListener(marker, 'click', function() {
        console.log("상세페이지 이동");
    });

    markers.push({ marker: marker, infoWindow: infoWindow });

    return marker;
}

function showMarkers() {
    for (var i = 0, ii = latlngs.length; i < ii; i += 2) {
        var marker = createMarker(latlngs[i], latlngs[i + 1]);
    }
}

function hideMarkers() {
    for (var i = 0, ii = markers.length; i < ii; i++) {
        markers[i].marker.setMap(null);
    }
}

function showMarkersOnHover() {
    for (var i = 0, ii = markers.length; i < ii; i++) {
        var markerData = markers[i];
        if (markerData && markerData.marker) {
            var marker = markerData.marker;
            naver.maps.Event.addListener(marker, 'mouseover', function() {
                markerData.infoWindow.open(map, marker);
            });

            naver.maps.Event.addListener(marker, 'mouseout', function() {
                markerData.infoWindow.close();
            });
        }
    }
}

/////////////////////////////////////////////////////////////////////////////////////
var currentCategory = null;
$(document).ready(function () {
    loadRestaurants();
});


function loadRestaurantsByCategory(category) {
    if (currentCategory === category) {
        // 같은 카테고리가 다시 선택되면 전체 목록을 로드
        loadRestaurants();
        currentCategory = null; // 현재 선택된 카테고리 초기화
    } else {
        // 다른 카테고리가 선택되면 해당 카테고리의 목록을 로드
        $.ajax({
            type: "GET",
            url: "/api/list",
            success: function (response) {
                let restaurants = response['stars_list'];
                $('#restaurant-list-ul').empty(); // 기존 목록을 지우고 새 목록을 표시

                latlngs.length = 0;
                hideMarkers();
                for (let i = 0; i < restaurants.length; i++) {
                    let restaurant = restaurants[i];
                    if (restaurant['category'] === category) {
                        let name = restaurant['name'];
                        let location = restaurant['location'];
                        let category = restaurant['category'];
                        latlngs.push(new naver.maps.LatLng(restaurant['Y'], restaurant['X']), name);

                        console.log(latlngs.length);
                        let listItemHtml = `<li>${name} - 위치: ${location}</li>, 카테고리: ${category}</li>`;
                        $('#restaurant-list-ul').append(listItemHtml);
                    }
                }
                if (streetLayer.getMap() == null) {
                    showMarkers();
                }
                currentCategory = category; // 현재 선택된 카테고리 업데이트
            },
            error: function (error) {
                console.error("레스토랑 목록을 불러오는데 실패했습니다: ", error);
            }
        });
    }
}

function loadRestaurants() {
    $.ajax({
        type: "GET",
        url: "/api/list",
        success: function (response) {
            let restaurants = response['stars_list'];
            $('#restaurant-list-ul').empty(); // 기존 목록을 지우고 새 목록을 표시

            latlngs.length = 0;
            hideMarkers();
            for (let i = 0; i < restaurants.length; i++) {
                let restaurant = restaurants[i];
                let name = restaurant['name'];
                let location = restaurant['location'];
                let category = restaurant['category'];
                latlngs.push(new naver.maps.LatLng(restaurant['Y'], restaurant['X']), name);
                let listItemHtml = `<li>${name} - 위치: ${location}, 카테고리: ${category}</li>`;
                $('#restaurant-list-ul').append(listItemHtml);
            }
            if (streetLayer.getMap() == null) {
                showMarkers();
            }
        },
        error: function (error) {
            console.error("레스토랑 목록을 불러오는데 실패했습니다: ", error);
        }
    });
}


</script>
</body>
</html>